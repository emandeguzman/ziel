{{ define "main" }}
<canvas id="bg"></canvas>
<canvas id="mid"></canvas>
<canvas id="mid1"></canvas>
<canvas id="mid2"></canvas>
<canvas id="fg"></canvas>


<!-- { {$canvas        := resources.Get "/js/canvas.js"}} -->
<!-- { {$canvasItem    := resources.Get "/js/canvasItem.js"}} -->
<!-- { {$canvasShape   := resources.Get "/js/canvasShape.js"}} -->
<!-- { {$canvasImage   := resources.Get "/js/canvasImage.js"}} -->
<!-- { {$celestialBody := resources.Get "/js/celestialBody.js"}} -->
<!-- { {$intro         := resources.Get "/js/intro.js"   | resources.ExecuteAsTemplate "js/intro.js" . }} -->
<!-- { {$journey       := resources.Get "/js/journey.js" | resources.ExecuteAsTemplate "js/journey.js" . }} -->

<!-- < script src='{ {(slice $canvas $canvasItem $canvasShape $canvasImage $celestialBody $intro $journey | resources.Concat "js/bundle.js" ).Permalink}}'></script> -->

<script src='{{(resources.Get "/js/test.js").Permalink}}'></script>
<script src='{{(resources.Get "/js/canvas.js").Permalink}}'></script>
<script src='{{(resources.Get "/js/canvasItem.js").Permalink}}'></script>
<script src='{{(resources.Get "/js/canvasShape.js").Permalink}}'></script>
<script src='{{(resources.Get "/js/canvasImage.js").Permalink}}'></script>
<script src='{{(resources.Get "/js/celestialBody.js").Permalink}}'></script>
<script src='{{(resources.Get "/js/intro.js"   | resources.ExecuteAsTemplate "js/intro.js" . ).Permalink}}'></script>
<script src='{{(resources.Get "/js/journey.js" | resources.ExecuteAsTemplate "js/journey.js" . ).Permalink}}'></script>


<script>
    function tracking(msg) {console.debug(msg)}

    /**
     * loads an image asynchronously
     * @params (string) imgurl
     */
    function loadImg(imgurl){
        return new Promise(resolve => {
            document.querySelectorAll("img").forEach(img=>{
                if (img.src == imgurl) {
                    tracking(`img already loaded ${imgurl}`);
                    resolve(img);
                    return;
                }
            });

            const img = document.createElement("IMG");
            document.body.appendChild(img);
            img.style.display = "none";
            img.src = imgurl;
            img.addEventListener("load", ()=>{
                tracking(`img loaded ${imgurl}`);
                resolve(img);
            })

        })
    }

    function getX(x) { return x;}
    function getY(y) { return y;}
    function getWidth(w) { return w;}
    function getHeight(h) { return h;}
    function getRadius(r) { return r;}
    
    (async ()=>{
        await new Promise((resolve, reject)=>{
            domready(()=>{resolve()});
        })

        tracking("start");
        const bg = new Canvas("#bg");
        const mid = new Canvas("#mid");
        const mid1 = new Canvas("#mid1");
        const mid2 = new Canvas("#mid2");
        const fg = new Canvas("#fg");

        let step = "intro";
        step = "journey";
        loop: {
            for(;;) {
                switch(step) {
                    case "intro":
                        if (await intro(bg, mid, fg) == "next") {
                            step = "journey";
                        }
                        break;
                    case "journey":
                    if (await journey(bg, mid, mid1, mid2, fg) == "next") {
                            step = "end";
                        }
                        break;
                    case "end":
                        tracking("end");
                        break loop;
                }
            }
        }
    })();
</script>
{{ end }}
